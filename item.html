<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>price</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fira+Sans:wght@300;600&display=swap');
    body {
      background-color: black;
    }

    .prices {
      font-family: 'Fira Sans', sans-serif;
      color: white;
      font-size: 2.7vmin;
      position: absolute;
      top: 45%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      margin-top: 10vh;
      width: 100vw;
    }

    .goback {
      background-color: black;
      color: white;
      font-family: "Fira Sans", sans-serif;
      /* font-weight: bold; */
      border: none;
      font-size: 5vmin;
      cursor: pointer;
      padding: 1vmin;
      position: absolute;
      top: 0; 
      left: 0;
      transition: font-size 600ms;
    }

    .goback:hover {
      font-size: 5.5vmin;
      transition: font-size 300ms;
    }

    .moni {
      color: goldenrod;
    }

	.up,
	.down {
		margin-top: 5vmin;
	}

	.up i {
		color: lime;
	}

	.down i {
		color: red;
	}
  </style>
</head>
<body>
  <div class="prices" id="prices"></div>
  <button class="goback" onclick="clicked()" id="goback"></button>
  <script>

    // Translates variations of ItemIDs
    fetch(`https://api.slothpixel.me/api/skyblock/items`)
    .then(response => response.json())
    .then(data => {
        var searchQuery = new URLSearchParams(window.location.search).get("query");
        var word = searchQuery;
        let words = searchQuery.toLowerCase().split(" ");
        for (let i = 0; i < words.length; i++) {
            words[i] = words[i].charAt(0).toUpperCase() + words[i].slice(1);
        }
        var item = words.join(" ");
        const itemsByName = {};
        for (let key in data) {
            let itemob = data[key];
            itemsByName[itemob.name] = itemob;
        }
        const itemo = itemsByName[item];
        if (!itemo) {
          if (word && !word.includes("_")) {
                word = word.replace(/ /g, "_")
            }
            word = word.toUpperCase();

            if (word.includes("ESSENCE")) {
                const wordss = word.split("_");
                [wordss[0], wordss[1]] = [wordss[1], wordss[0]];
                word = wordss.join(" ");
                word = word.replace(/ /g, "_")
            }
            var temId = word;


            let words = word.toLowerCase().split("_");
            for (let i = 0; i < words.length; i++) {
                words[i] = words[i].charAt(0).toUpperCase() + words[i].slice(1);
            }
            var item = words.join(" ");

            if (item.includes("Essence")) {
                const wordss = item.split(" ");
                [wordss[0], wordss[1]] = [wordss[1], wordss[0]];
                item = wordss.join(" ");
            }

            if (item.includes("Enchantment")) {
                item = item.replace("Enchantment", "");
            }
            word = item;
        } else {
          word = itemo.id;
            var temId = word;
            var item = itemo.name;
            console.log(`The ID of ${searchQuery} is ${word}`);
        }
        fetch(`https://api.slothpixel.me/api/skyblock/bazaar/${temId}`)
            .then(response => response.json())
            .then(data => {

				let sellMovingWeek = data["quick_status"]["sellMovingWeek"];
				let buyMovingWeek = data["quick_status"]["buyMovingWeek"];

				

				console.log(sellMovingWeek)


                document.title = `${item} prices`
                let buyOrSellSummaryWord = item;
                if (data["buy_summary"][0]["amount"] > 1) {
                    buyOrSellSummaryWord += "s"
                }
                
                let buyPrice = data["buy_summary"][0]["pricePerUnit"];
                let sellPrice = data["sell_summary"][0]["pricePerUnit"];

                const container = document.getElementById('prices');

				if (sellMovingWeek < buyMovingWeek) {
				let percent = Math.ceil(((buyMovingWeek - sellMovingWeek) / buyMovingWeek) * 100);
					container.innerHTML = `
				  <h1>Economic Information About ${item}</h1>
				  <h2>Prices</h2>
				  <p>Buy Price: <span class="moni">${buyPrice.toLocaleString()} coins</span> (${data["buy_summary"][0]["amount"]} ${buyOrSellSummaryWord} bought in last buy order)</p>
				  <p>Sell Price: <span class="moni">${sellPrice.toLocaleString()} coins</span> (${data["sell_summary"][0]["amount"]} ${buyOrSellSummaryWord} sold in last sell offer)</p>
				  <p class="up"><i class="fa fa-arrow-circle-up"></i> ${percent}% more bought than sold (prices on its way up)</p>
				`;
				} else {
				let percent = Math.ceil(((sellMovingWeek - buyMovingWeek) / sellMovingWeek) * 100);
					container.innerHTML = `
				  <h1>Economic Information About ${item}</h1>
				  <h2>Prices</h2>
				  <p>Buy Price: <span class="moni">${buyPrice.toLocaleString()} coins</span> (${data["buy_summary"][0]["amount"]} ${buyOrSellSummaryWord} bought in last buy order)</p>
				  <p>Sell Price: <span class="moni">${sellPrice.toLocaleString()} coins</span> (${data["sell_summary"][0]["amount"]} ${buyOrSellSummaryWord} sold in last sell offer)</p>
				  <p class="down"><i class="fa fa-arrow-circle-down"></i> ${percent}% more sold than bought (prices on its way down)</p>
				`;
				}
                const goback = document.getElementById("goback");
                goback.innerHTML = `<i class="fa fa-long-arrow-left"></i> Go Back (Esc)`
            })
            .catch(error => {
                console.error(error);
                const container = document.getElementById('prices');
                container.innerHTML = '<h1>invalid item</h1>';

                const goback = document.getElementById("goback");
                goback.innerHTML = `<i class="fa fa-long-arrow-left"></i> Go Back (Esc)`
            });
    })
    .catch(error => {
        console.error(error);
    }); 

function clicked() {
    window.location.href = "index.html";
    document.title = "Bazaar Price Tracker";
}

document.addEventListener("keydown", function(event) {
  if (event.key === "Escape") {
    clicked();
  }
});
</script>
</body>
</html>